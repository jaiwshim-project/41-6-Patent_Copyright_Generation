<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ì‹œë³´ë“œ | AI-IP Strategy OS</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .dash-header {
      background: linear-gradient(135deg, #1e1b4b 0%, #2e2783 50%, #4c1d95 100%);
      padding: 2.5rem 2rem;
      border-bottom: 1px solid rgba(150,120,255,0.15);
    }
    .dash-header h1 { color: #fcd34d !important; }
    .dash-header p  { color: rgba(255,255,255,0.82) !important; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem;
      margin-bottom: 2rem;
    }
    .kpi-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 1.4rem 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .kpi-label {
      font-size: 0.72rem; color: var(--text-300);
      text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 0.5rem; font-weight: 700;
    }
    .kpi-value { font-size: 2rem; font-weight: 900; line-height: 1; }
    .kpi-sub { font-size: 0.75rem; color: var(--text-400); margin-top: 0.3rem; }
    .kpi-desc {
      font-size: 0.72rem;
      color: #1e6bb5;
      margin-top: 0.65rem;
      padding-top: 0.6rem;
      border-top: 1px solid #dbeafe;
      line-height: 1.5;
      font-weight: 500;
    }

    .chart-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 1.75rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .chart-title {
      font-size: 0.75rem; font-weight: 700; color: var(--text-300);
      text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 1.25rem;
    }

    .radar-wrap {
      display: flex; align-items: center; justify-content: center;
      position: relative; height: 220px;
    }
    .radar-svg { width: 200px; height: 200px; }

    .portfolio-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
      gap: 0.5rem;
      padding: 0.875rem 1rem;
      border-bottom: 1px solid #f1f5f9;
      align-items: center;
      font-size: 0.875rem;
      transition: background 0.15s;
    }
    .portfolio-row:hover { background: #f8faff; }
    .portfolio-header {
      font-size: 0.72rem; font-weight: 700; color: var(--text-300);
      text-transform: uppercase; letter-spacing: 0.06em;
      background: #f8fafc; border-radius: 10px 10px 0 0;
    }

    .gauge-ring { position: relative; width: 80px; height: 80px; }
    .gauge-svg { width: 80px; height: 80px; transform: rotate(-90deg); }
    .gauge-bg { fill: none; stroke: #e2e8f0; stroke-width: 8; }
    .gauge-fill { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1.5s ease; }
    .gauge-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .gauge-num { font-size: 1.1rem; font-weight: 800; }
    .gauge-sub { font-size: 0.6rem; color: var(--text-400); }

    @media (max-width: 768px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .portfolio-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- Navbar injected by layout.js -->

<!-- Header -->
<div class="dash-header">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
      <div>
        <h1 style="font-size:1.75rem;font-weight:800;margin-bottom:0.25rem">ğŸ“Š IP í¬íŠ¸í´ë¦¬ì˜¤ ì „ëµ ëŒ€ì‹œë³´ë“œ</h1>
        <p style="color:rgba(255,255,255,0.7);font-size:0.9rem">ì§€ì‹ì¬ì‚°ê¶Œ ìì‚°ì˜ ì¢…í•© í˜„í™© ë° ì „ëµ ë¶„ì„</p>
      </div>
      <div style="display:flex;gap:0.75rem">
        <button class="btn btn-outline" onclick="addCurrentProject()">+ í˜„ì¬ í”„ë¡œì íŠ¸ ì¶”ê°€</button>
        <button class="btn btn-primary" onclick="runPortfolioAnalysis()">ğŸ§  AI ì „ëµ ë¶„ì„</button>
      </div>
    </div>
  </div>
</div>

<div class="page-content">

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">í¬íŠ¸í´ë¦¬ì˜¤ ì´ IP</div>
      <div class="kpi-value" id="kpi_total" style="color:#60a5fa">0</div>
      <div class="kpi-sub" id="kpi_total_sub">íŠ¹í—ˆ 0 Â· ì €ì‘ê¶Œ 0</div>
      <div class="kpi-desc">ë“±ë¡ëœ ì „ì²´ ì§€ì‹ì¬ì‚°ê¶Œ ìì‚° ìˆ˜ì…ë‹ˆë‹¤. íŠ¹í—ˆì™€ ì €ì‘ê¶Œì„ í•©ì‚°í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ê·œëª¨ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">í‰ê·  PSM ì ìˆ˜</div>
      <div class="kpi-value" id="kpi_psm" style="color:#a78bfa">-</div>
      <div class="kpi-sub">íŠ¹í—ˆ ê°•ë„ í‰ê· </div>
      <div class="kpi-desc">Patent Scoring Model â€” ì‹ ê·œì„±Â·ì§„ë³´ì„±Â·ì²­êµ¬í•­ ë“± 7ê°œ í•­ëª©ì„ 100ì  ë§Œì ìœ¼ë¡œ í‰ê°€í•œ íŠ¹í—ˆ í’ˆì§ˆ ì ìˆ˜ì…ë‹ˆë‹¤.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">í‰ê·  RSI ì§€ìˆ˜</div>
      <div class="kpi-value" id="kpi_rsi" style="color:#34d399">-</div>
      <div class="kpi-sub">ê¶Œë¦¬ ê°•ë„ í‰ê· </div>
      <div class="kpi-desc">Rights Strength Index â€” (ê¶Œë¦¬ë²”ìœ„ Ã— ê¸°ìˆ ì„± Ã— ì‹œì¥ì„±) Ã· ì·¨ì•½ì„± ê³µì‹ìœ¼ë¡œ ì‚°ì¶œí•œ ê¶Œë¦¬ ì‹¤ì§ˆ ê°•ë„ ì§€ìˆ˜ì…ë‹ˆë‹¤.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">í¬íŠ¸í´ë¦¬ì˜¤ ê°•ë„</div>
      <div class="kpi-value" id="kpi_pss" style="color:#fbbf24">-</div>
      <div class="kpi-sub">PSS (Portfolio Strength)</div>
      <div class="kpi-desc">Portfolio Strength Score â€” PSM ì ìˆ˜ì™€ RSI ì§€ìˆ˜ë¥¼ ì¢…í•©í•´ ì‚°ì¶œí•œ ì „ì²´ IP í¬íŠ¸í´ë¦¬ì˜¤ì˜ ê²½ìŸë ¥ ì§€ìˆ˜ì…ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid-2" style="gap:1.5rem;margin-bottom:1.5rem">

    <!-- Patent Strength Radar -->
    <div class="chart-card">
      <div class="chart-title">â¬¡ íŠ¹í—ˆ ê°•ë„ ë ˆì´ë”</div>
      <div class="radar-wrap">
        <svg class="radar-svg" viewBox="0 0 200 200" id="radarChart">
          <!-- Background circles -->
          <polygon points="100,20 180,65 180,135 100,180 20,135 20,65" fill="none" stroke="#334155" stroke-width="1"/>
          <polygon points="100,40 160,75 160,125 100,160 40,125 40,75" fill="none" stroke="#334155" stroke-width="1"/>
          <polygon points="100,60 140,85 140,115 100,140 60,115 60,85" fill="none" stroke="#334155" stroke-width="1"/>
          <polygon points="100,80 120,95 120,105 100,120 80,105 80,95" fill="none" stroke="#334155" stroke-width="1"/>
          <!-- Axes -->
          <line x1="100" y1="20" x2="100" y2="180" stroke="#334155" stroke-width="1"/>
          <line x1="20" y1="65" x2="180" y2="135" stroke="#334155" stroke-width="1"/>
          <line x1="20" y1="135" x2="180" y2="65" stroke="#334155" stroke-width="1"/>
          <!-- Data polygon -->
          <polygon id="radarData" points="100,40 155,78 155,122 100,155 45,122 45,78"
            fill="rgba(37,99,235,0.2)" stroke="#2563eb" stroke-width="2"/>
          <!-- Labels -->
          <text x="100" y="14" text-anchor="middle" fill="#94a3b8" font-size="10">ì‹ ê·œì„±</text>
          <text x="185" y="67" fill="#94a3b8" font-size="10">ì§„ë³´ì„±</text>
          <text x="185" y="138" fill="#94a3b8" font-size="10">ì‚°ì—…ì„±</text>
          <text x="100" y="195" text-anchor="middle" fill="#94a3b8" font-size="10">ì²­êµ¬í•­</text>
          <text x="2" y="138" fill="#94a3b8" font-size="10">ë°©ì–´ë ¥</text>
          <text x="5" y="67" fill="#94a3b8" font-size="10">í™•ì¥ì„±</text>
        </svg>
      </div>
      <div style="display:flex;justify-content:center;gap:1rem;margin-top:0.5rem">
        <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.75rem">
          <div style="width:12px;height:12px;background:#2563eb;border-radius:2px"></div>
          í˜„ì¬ í”„ë¡œì íŠ¸
        </div>
      </div>
    </div>

    <!-- Score Gauges -->
    <div class="chart-card">
      <div class="chart-title">ğŸ“ˆ í•µì‹¬ ì§€í‘œ í˜„í™©</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem" id="gaugesContainer">
        <div style="text-align:center">
          <div class="gauge-ring" style="margin:0 auto">
            <svg class="gauge-svg" viewBox="0 0 80 80">
              <circle class="gauge-bg" cx="40" cy="40" r="30"/>
              <circle class="gauge-fill" cx="40" cy="40" r="30" stroke="#60a5fa"
                stroke-dasharray="188.5" stroke-dashoffset="94" id="gauge_psm_circle"/>
            </svg>
            <div class="gauge-text">
              <span class="gauge-num" id="gauge_psm" style="color:#60a5fa">-</span>
              <span class="gauge-sub">PSM</span>
            </div>
          </div>
        </div>
        <div style="text-align:center">
          <div class="gauge-ring" style="margin:0 auto">
            <svg class="gauge-svg" viewBox="0 0 80 80">
              <circle class="gauge-bg" cx="40" cy="40" r="30"/>
              <circle class="gauge-fill" cx="40" cy="40" r="30" stroke="#34d399"
                stroke-dasharray="188.5" stroke-dashoffset="94" id="gauge_rsi_circle"/>
            </svg>
            <div class="gauge-text">
              <span class="gauge-num" id="gauge_rsi" style="color:#34d399">-</span>
              <span class="gauge-sub">RSI</span>
            </div>
          </div>
        </div>
        <div style="text-align:center">
          <div class="gauge-ring" style="margin:0 auto">
            <svg class="gauge-svg" viewBox="0 0 80 80">
              <circle class="gauge-bg" cx="40" cy="40" r="30"/>
              <circle class="gauge-fill" cx="40" cy="40" r="30" stroke="#fbbf24"
                stroke-dasharray="188.5" stroke-dashoffset="151" id="gauge_rej_circle"/>
            </svg>
            <div class="gauge-text">
              <span class="gauge-num" id="gauge_rej" style="color:#fbbf24">-</span>
              <span class="gauge-sub">ê±°ì ˆìœ„í—˜</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bar Charts for PSM breakdown -->
      <div class="bar-chart" id="psmBars">
        <div style="color:var(--text-secondary);font-size:0.8rem;text-align:center">í”„ë¡œì íŠ¸ ë¶„ì„ í›„ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- Portfolio Table -->
  <div class="chart-card" style="margin-bottom:1.5rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <div class="chart-title" style="margin-bottom:0">ğŸ“‹ IP ìì‚° ëª©ë¡</div>
      <button class="btn btn-outline" style="font-size:0.8rem;padding:0.4rem 0.75rem" onclick="clearPortfolio()">ì´ˆê¸°í™”</button>
    </div>
    <div>
      <div class="portfolio-row portfolio-header">
        <div>ëª…ì¹­</div>
        <div>ìœ í˜•</div>
        <div>PSM</div>
        <div>RSI</div>
        <div>ê±°ì ˆìœ„í—˜</div>
        <div>ë“±ê¸‰</div>
      </div>
      <div id="portfolioList">
        <div style="text-align:center;padding:2rem;color:var(--text-secondary);font-size:0.875rem">
          ë¶„ì„í•œ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
          íŠ¹í—ˆ ë˜ëŠ” ì €ì‘ê¶Œ ë¶„ì„ì„ ì™„ë£Œí•˜ë©´ ì´ê³³ì— ìë™ ì¶”ê°€ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- AI Analysis & Insights -->
  <div class="grid-2" style="gap:1.5rem;margin-bottom:1.5rem">
    <div class="chart-card">
      <div class="chart-title">ğŸ§  AI ì „ëµ ì¸ì‚¬ì´íŠ¸</div>
      <div id="aiInsights">
        <div class="insight-card">
          <div class="insight-icon">ğŸ’¡</div>
          <div>
            <div class="insight-title">AI ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
            <div class="insight-desc">í¬íŠ¸í´ë¦¬ì˜¤ì— í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  "AI ì „ëµ ë¶„ì„" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¸ì‚¬ì´íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">ğŸ“… í™œë™ íƒ€ì„ë¼ì¸</div>
      <div id="timeline">
        <div style="color:var(--text-secondary);font-size:0.875rem">í”„ë¡œì íŠ¸ ì¶”ê°€ í›„ íƒ€ì„ë¼ì¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- PSS Formula Card -->
  <div class="chart-card" style="margin-bottom:1.5rem">
    <div class="chart-title">ğŸ“ í¬íŠ¸í´ë¦¬ì˜¤ ê°•ë„ ì ìˆ˜ (PSS) ì‚°ì¶œ ëª¨ë¸</div>
    <div class="grid-3" style="gap:1.5rem">
      <div>
        <div style="font-size:0.72rem;font-weight:700;color:var(--text-300);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:0.5rem">PSS ê³µì‹</div>
        <div style="background:var(--bg-alt);border:1.5px solid var(--border-blue);border-radius:8px;padding:1rem;font-family:monospace;font-size:0.75rem;font-weight:700;letter-spacing:0.07em;line-height:2;color:var(--text-200)">
          PSS =<br>
          (í‰ê·  RSI Ã— êµ­ê°€ ë‹¤ì–‘ì„±<br>
          Ã— ê¸°ìˆ  ë‹¤ì–‘ì„±)<br>
          Ã· ì§‘ì¤‘ë„ ë¦¬ìŠ¤í¬
        </div>
      </div>
      <div>
        <div style="font-size:0.72rem;font-weight:700;color:var(--text-300);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:0.5rem">RSI ê³µì‹</div>
        <div style="background:var(--bg-alt);border:1.5px solid var(--border-blue);border-radius:8px;padding:1rem;font-family:monospace;font-size:0.75rem;font-weight:700;letter-spacing:0.07em;line-height:2;color:var(--text-200)">
          RSI =<br>
          (L Ã— T Ã— M) Ã· V<br><br>
          L=ë²•ì ì•ˆì •ì„±<br>
          T=ê¸°ìˆ ë³µì¡ë„<br>
          M=ì‹œì¥ë…ì ì„±<br>
          V=ìš°íšŒê°€ëŠ¥ì„±
        </div>
      </div>
      <div>
        <div style="font-size:0.72rem;font-weight:700;color:var(--text-300);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:0.5rem">PSM ê³µì‹</div>
        <div style="background:var(--bg-alt);border:1.5px solid var(--border-blue);border-radius:8px;padding:1rem;font-family:monospace;font-size:0.75rem;font-weight:700;letter-spacing:0.07em;line-height:2;color:var(--text-200)">
          PSM =<br>
          0.25N + 0.20I +<br>
          0.10A + 0.10E +<br>
          0.15C + 0.10D +<br>
          0.10X
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div style="display:flex;gap:1rem;flex-wrap:wrap">
    <a href="patent.html" class="btn btn-primary btn-lg">âš™ï¸ ìƒˆ íŠ¹í—ˆ ë¶„ì„</a>
    <a href="copyright.html" class="btn btn-success btn-lg">Â©ï¸ ìƒˆ ì €ì‘ê¶Œ ë“±ë¡</a>
    <button class="btn btn-secondary btn-lg" onclick="exportPortfolio()">ğŸ“¤ í¬íŠ¸í´ë¦¬ì˜¤ ë‚´ë³´ë‚´ê¸°</button>
    <a href="index.html" class="btn btn-outline btn-lg">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

</div><!-- /page-content -->

<script src="assets/js/common.js"></script>
<script src="assets/js/layout.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Portfolio Data Management
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPortfolio() {
  try {
    return JSON.parse(localStorage.getItem('ip_portfolio') || '[]');
  } catch { return []; }
}

function savePortfolio(data) {
  localStorage.setItem('ip_portfolio', JSON.stringify(data));
}

function addCurrentProject() {
  const proj = getProject();
  if (!proj || !proj.title) {
    showToast('ë¨¼ì € í™ˆì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'warning');
    return;
  }

  const portfolio = getPortfolio();
  const exists = portfolio.find(p => p.title === proj.title);
  if (exists) { showToast('ì´ë¯¸ í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ëœ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.', 'warning'); return; }

  const item = {
    id: Date.now(),
    title: proj.title,
    type: proj.type || 'patent',
    industry: proj.industry || '-',
    psm: proj.psm || '-',
    rsi: proj.rsi || '-',
    rejProb: proj.rejProb || '-',
    addedAt: Date.now()
  };

  portfolio.push(item);
  savePortfolio(portfolio);
  renderPortfolio();
  updateKPIs();
  showToast('í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

function renderPortfolio() {
  const portfolio = getPortfolio();
  const list = document.getElementById('portfolioList');

  if (!portfolio.length) {
    list.innerHTML = `<div style="text-align:center;padding:2rem;color:var(--text-secondary);font-size:0.875rem">
      ë¶„ì„í•œ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>íŠ¹í—ˆ ë˜ëŠ” ì €ì‘ê¶Œ ë¶„ì„ì„ ì™„ë£Œí•˜ë©´ ì´ê³³ì— ìë™ ì¶”ê°€ë©ë‹ˆë‹¤.
    </div>`;
    return;
  }

  list.innerHTML = portfolio.map(item => {
    const psmNum = parseFloat(item.psm);
    const rsiNum = parseFloat(item.rsi);
    const psmColor = isNaN(psmNum) ? '#94a3b8' : psmNum >= 80 ? '#34d399' : psmNum >= 60 ? '#fbbf24' : '#f87171';
    const rsiGrade = isNaN(rsiNum) ? '-' : rsiNum >= 150 ? 'ì „ëµí•µì‹¬' : rsiNum >= 100 ? 'ê°•í•¨' : rsiNum >= 50 ? 'ë³´í†µ' : 'ì•½í•¨';
    const rsiColor = isNaN(rsiNum) ? '#94a3b8' : rsiNum >= 150 ? '#60a5fa' : rsiNum >= 100 ? '#34d399' : rsiNum >= 50 ? '#fbbf24' : '#f87171';
    const typeIcon = item.type === 'patent' ? 'âš™ï¸' : 'Â©ï¸';
    const typeBadge = item.type === 'patent' ? 'badge-blue' : 'badge-green';

    return `<div class="portfolio-row">
      <div>
        <div style="font-weight:600">${item.title}</div>
        <div style="font-size:0.75rem;color:var(--text-secondary)">${item.industry}</div>
      </div>
      <div><span class="badge ${typeBadge}">${typeIcon} ${item.type === 'patent' ? 'íŠ¹í—ˆ' : 'ì €ì‘ê¶Œ'}</span></div>
      <div style="font-weight:700;color:${psmColor}">${item.psm !== '-' ? item.psm + 'ì ' : '-'}</div>
      <div style="font-weight:700;color:${rsiColor}">${item.rsi !== '-' ? item.rsi : '-'}</div>
      <div style="font-weight:700;color:${item.rejProb !== '-' ? '#fbbf24' : '#94a3b8'}">${item.rejProb !== '-' ? item.rejProb + '%' : '-'}</div>
      <div><span class="badge" style="background:${rsiColor}22;color:${rsiColor}">${rsiGrade}</span></div>
    </div>`;
  }).join('');
}

function updateKPIs() {
  const portfolio = getPortfolio();
  const patents = portfolio.filter(p => p.type === 'patent');
  const copyrights = portfolio.filter(p => p.type !== 'patent');

  document.getElementById('kpi_total').textContent = portfolio.length;
  document.getElementById('kpi_total_sub').textContent = `íŠ¹í—ˆ ${patents.length} Â· ì €ì‘ê¶Œ ${copyrights.length}`;

  const psmVals = patents.map(p => parseFloat(p.psm)).filter(v => !isNaN(v));
  const rsiVals = patents.map(p => parseFloat(p.rsi)).filter(v => !isNaN(v));

  if (psmVals.length) {
    const avgPsm = (psmVals.reduce((a,b)=>a+b,0) / psmVals.length).toFixed(1);
    document.getElementById('kpi_psm').textContent = avgPsm;
    document.getElementById('gauge_psm').textContent = avgPsm;
    updateGauge('gauge_psm_circle', parseFloat(avgPsm) / 100);
  }
  if (rsiVals.length) {
    const avgRsi = Math.round(rsiVals.reduce((a,b)=>a+b,0) / rsiVals.length);
    document.getElementById('kpi_rsi').textContent = avgRsi;
    document.getElementById('gauge_rsi').textContent = avgRsi;
    updateGauge('gauge_rsi_circle', Math.min(1, avgRsi / 200));

    const pss = (avgRsi * 1.2).toFixed(1);
    document.getElementById('kpi_pss').textContent = pss;
  }
}

function updateGauge(id, pct) {
  const circle = document.getElementById(id);
  if (!circle) return;
  const circumference = 188.5;
  circle.style.strokeDashoffset = circumference * (1 - Math.min(1, Math.max(0, pct)));
}

function updateCurrentProjectCharts() {
  const proj = getProject();
  if (!proj) return;

  if (proj.psm) {
    document.getElementById('gauge_psm').textContent = proj.psm;
    updateGauge('gauge_psm_circle', proj.psm / 100);
  }
  if (proj.rsi) {
    document.getElementById('gauge_rsi').textContent = proj.rsi;
    updateGauge('gauge_rsi_circle', Math.min(1, proj.rsi / 200));
  }
  if (proj.rejProb) {
    document.getElementById('gauge_rej').textContent = proj.rejProb + '%';
    updateGauge('gauge_rej_circle', proj.rejProb / 100);
  }

  // Update PSM bar chart
  updatePSMBars(proj);
  updateTimeline(proj);
}

function updatePSMBars(proj) {
  const barsEl = document.getElementById('psmBars');
  if (!proj.psm) return;

  const items = [
    { label: 'ì‹ ê·œì„±', value: 75, color: '#60a5fa' },
    { label: 'ì§„ë³´ì„±', value: 68, color: '#a78bfa' },
    { label: 'ì‚°ì—…ì„±', value: 82, color: '#34d399' },
    { label: 'ì²­êµ¬í•­ ì™„ì„±ë„', value: 71, color: '#fbbf24' },
    { label: 'ë°©ì–´ë ¥', value: 65, color: '#fb923c' },
    { label: 'í™•ì¥ì„±', value: 78, color: '#38bdf8' },
  ];

  barsEl.innerHTML = items.map(item => `
    <div class="bar-item">
      <div class="bar-label">
        <span>${item.label}</span>
        <span style="color:${item.color};font-weight:700">${item.value}%</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:0%;background:${item.color}" data-target="${item.value}"></div>
      </div>
    </div>
  `).join('');

  // Animate
  setTimeout(() => {
    document.querySelectorAll('.bar-fill').forEach(el => {
      el.style.width = el.dataset.target + '%';
    });
  }, 100);
}

function updateTimeline(proj) {
  const tl = document.getElementById('timeline');
  const now = new Date();
  tl.innerHTML = `
    <div class="timeline-item">
      <div class="timeline-dot green"></div>
      <div>
        <div style="font-size:0.875rem;font-weight:600">${proj.title || 'í”„ë¡œì íŠ¸'} ë¶„ì„ ì™„ë£Œ</div>
        <div style="font-size:0.75rem;color:var(--text-secondary)">${new Date(proj.updatedAt||Date.now()).toLocaleDateString('ko-KR')}</div>
      </div>
    </div>
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div>
        <div style="font-size:0.875rem;font-weight:600">íŠ¹í—ˆ ëª…ì„¸ì„œ ì´ˆì•ˆ ìƒì„±</div>
        <div style="font-size:0.75rem;color:var(--text-secondary)">AI ìë™ ì™„ì„±</div>
      </div>
    </div>
    <div class="timeline-item">
      <div class="timeline-dot yellow"></div>
      <div>
        <div style="font-size:0.875rem;font-weight:600">ì¶œì› ê¶Œê³ </div>
        <div style="font-size:0.75rem;color:var(--text-secondary)">ë³€ë¦¬ì‚¬ ê²€í†  í›„ ì œì¶œ ê¶Œì¥</div>
      </div>
    </div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI Portfolio Analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runPortfolioAnalysis() {
  const portfolio = getPortfolio();
  const proj = getProject();

  if (!portfolio.length && !proj) {
    showToast('í¬íŠ¸í´ë¦¬ì˜¤ì— í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
    return;
  }

  const insightsEl = document.getElementById('aiInsights');
  insightsEl.innerHTML = `<div style="display:flex;align-items:center;gap:1rem;padding:1rem;color:var(--text-secondary)">
    <div class="spinner"></div> AI í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì¤‘...
  </div>`;

  const portfolioSummary = portfolio.map(p =>
    `- ${p.title} (${p.type === 'patent' ? 'íŠ¹í—ˆ' : 'ì €ì‘ê¶Œ'}, PSM: ${p.psm}, RSI: ${p.rsi})`
  ).join('\n');

  const currentProj = proj ? `í˜„ì¬ ë¶„ì„ ì¤‘: ${proj.title} (${proj.industry}, PSM: ${proj.psm || '-'}, RSI: ${proj.rsi || '-'})` : '';

  const prompt = `IP ì „ëµ ì»¨ì„¤í„´íŠ¸ AIì…ë‹ˆë‹¤. ì•„ë˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•˜ì—¬ ì „ëµ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

[í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©]
${portfolioSummary || 'í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì—†ìŒ'}
${currentProj}

ë‹¤ìŒ 5ê°€ì§€ ì „ëµ ì¸ì‚¬ì´íŠ¸ë¥¼ ê°ê° ì œëª©ê³¼ 2-3ë¬¸ì¥ ì„¤ëª…ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

INSIGHT_1: í¬íŠ¸í´ë¦¬ì˜¤ ê°•ì  ë¶„ì„
INSIGHT_2: ì·¨ì•½ì  ë° ë¦¬ìŠ¤í¬
INSIGHT_3: ì¦‰ì‹œ ê°œì„  ê¶Œê³  (êµ¬ì²´ì  ì•¡ì…˜)
INSIGHT_4: ì‹œì¥ ê¸°íšŒ ë° í™•ì¥ ì „ëµ
INSIGHT_5: íˆ¬ì ìœ ì¹˜/ê¸°ìˆ  ê°€ì¹˜ í‰ê°€ ê´€ì 

ê° ì¸ì‚¬ì´íŠ¸ë¥¼ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
[
  {"icon": "ì´ëª¨ì§€", "title": "ì œëª©", "desc": "ì„¤ëª…", "type": "success|warning|info|danger"},
  ...
]`;

  try {
    const result = await callGemini(prompt);
    try {
      // Try to parse JSON
      const jsonMatch = result.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        const insights = JSON.parse(jsonMatch[0]);
        insightsEl.innerHTML = insights.map(ins => {
          const colors = { success: '#059669', warning: '#d97706', info: '#2563eb', danger: '#dc2626' };
          return `<div class="insight-card">
            <div class="insight-icon">${ins.icon || 'ğŸ’¡'}</div>
            <div>
              <div class="insight-title" style="color:${colors[ins.type] || '#60a5fa'}">${ins.title}</div>
              <div class="insight-desc">${ins.desc}</div>
            </div>
          </div>`;
        }).join('');
        return;
      }
    } catch(e) {}

    // Fallback: display raw result
    insightsEl.innerHTML = `<div class="result-box">${formatMarkdown(result)}</div>`;
  } catch (e) {
    insightsEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    showToast(e.message, 'error');
  }
}

function clearPortfolio() {
  if (confirm('í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    localStorage.removeItem('ip_portfolio');
    renderPortfolio();
    updateKPIs();
    showToast('í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
  }
}

function exportPortfolio() {
  const portfolio = getPortfolio();
  const proj = getProject();

  const content = `AI-IP Strategy OS - IP í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬í¬íŠ¸
ìƒì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IP ìì‚° í˜„í™©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ì´ IP ìˆ˜: ${portfolio.length}ê±´

${portfolio.map((p,i) => `${i+1}. ${p.title}
   ìœ í˜•: ${p.type === 'patent' ? 'íŠ¹í—ˆ' : 'ì €ì‘ê¶Œ'}
   PSM ì ìˆ˜: ${p.psm || '-'}
   RSI ì§€ìˆ˜: ${p.rsi || '-'}
   ê±°ì ˆ ìœ„í—˜: ${p.rejProb || '-'}%`).join('\n\n')}

${proj ? `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
í˜„ì¬ ë¶„ì„ í”„ë¡œì íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ì œëª©: ${proj.title}
ë¶„ì•¼: ${proj.industry}
PSM: ${proj.psm || '-'}ì 
RSI: ${proj.rsi || '-'}
ê±°ì ˆìœ„í—˜: ${proj.rejProb || '-'}%` : ''}
`;

  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `IP_Portfolio_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('í¬íŠ¸í´ë¦¬ì˜¤ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Initialize
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  renderPortfolio();
  updateKPIs();
  updateCurrentProjectCharts();
});
</script>
</body>
</html>
